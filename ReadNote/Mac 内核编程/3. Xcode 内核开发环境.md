# Xcode 内核开发环境  



## 1. 开发语言 C++ 
__嵌入式C++__: c++的一个子集， 不包括以下功能： 
* 异常 
* 多继承 
* 模版
* 运行时类型信息  

降低代码量，减少内核内存占用， 避免编写额外的异常处理代码， 避免异常处理失败额内核恐慌问题   



## 2. 内核扩展实例  
两种扩展模式： 
* 通用扩展，不是一个硬件扩展驱动，可以由用户随时加载  
* I/O Kit 扩展，需要指定一个与之匹配的硬件设备，并且仅在设备存在时加载   

```c++
#include <mach/mach_types.h>
#include <libkern/libkern.h>  

```
1. 内核扩展不能包含用户空间的头文件`<stdio.h>`。 
2. 内核扩展仅在加载时才解决内核扩展的任何库依赖  
3. 需要在内核扩展的属性列表中声明需要依赖链接的库   

> 通过`uname -r` 查看内核版本   


## 3. 加载和卸载内核扩展 
内核扩展时操作系统内核中运行的一个代码模块。  

### 加载内核  
1. 将内核扩展复制到 `/System/library/Extensions`目录下自动加载。(在系统需要时进行加载，可能是启动时或硬件设备连接到计算机时)
2. 通过命令行手动加载    

系统将拒绝加载没有班组以下条件的内核扩展： 
* KEXT程序包及其包含的所有文件和文件夹都必须由 root 用户所有  
* KEXT程序包及其所有文件和文件夹都必须由 wheel 组所有 
* KEXT程序包及其包含的所有目录的权限掩码都必须是0755（rwxr-xr-x） 
* KEXT程序包中的所有文件的权限掩码都必须是0644(rw-r--r--)  

```shell
sudo chown -R root:wheel XXXXXX.kext
```
> 如果直接在Xcode构建目录改变权限，下次构建将出现错误，推荐将其复制到一个临时目录进行权限更新  


#### 加载内核命令  
* `kextload`: 将 KEXT 加载到内核  
* `kextunload`: 停止加载的 KEXT ， 将其从内核中卸载  
* `kextutil`: 将KEXT 加载到内核，饼可以提供诊断信息，判断内核加载失败的原因，以及生成一些对调试有用的信息  
* `kextstat`: 显示所有加载到内核中的 KEXT 列表  

```shell 
sudo kextload XXXXXX.text 

```


## 4. debug 查看输出
內核中调用printf()输出的结果將写人到硬盘上的一个日志文件中，路径在`/var/log/kernel.log`  
 








