# 环境搭建  

## 手机端

1. 越狱 
2. 添加软件源  
    * https://apt.saurik.com  
    * repo.incendo.ws  
    * apt.thebigboss.org/repofiles/cydia  
    * apt.saurik.com

3. 安装插件  
    * Apple File Conduit(替代品:afc2,afc2add)
    * AppSync Unified 
        绕过系统验证     
    * iFile(替代品： Filza file Manager, file browser)
        自由访问文件系统   
    * vim   
    * cycript   
    * adv-cmds (用来获取进程ID)

3. 安装脱壳工具  
    * Cluth 
    * dumpdecrypted   
    * frida-ios-dump  
    	`dump.py -l` __App必须运行起来才行__  
4. 更改debugserver权限  

5. cycript  
	* cycript -p SpringBoard




## Mac 端  
1. iFunBox  
    文件管理系统   

2. Alfred  
3. XtraFinder
4. iTerm2 
5. Go2Shell  
6. class-dump   
    `class-dump -H xxxx -o dir` 
7. theos 
    * 安装签名工具  
        `brew install ldid`  
    * 修改环境变量  
        ```shell 
        vim ~/.bash_profile 
        export THEOS=~/theos 
        export PATH=$THEOS/bin:$PATH 

        ```
    * 下载  
        `git clone --recursive https://github.com/theos/theos.git $THEOS`
    * 新建项目 
        `nic.pl`  
    
8. frida  
	`pip install frida-tools`  
	




### 3. 常用命令  
1. ps   
	显示进程状态， CPU使用率， 内存使用情况   
2. sysctl  
	检查设定 内核 配置  

3. netstat  
	显示网络连接， 路由表， 接口状态   

4. route  
	路由修改  

5. renice  
	调整程序运行的优先级   

6. ifconfig  
	查看网络配置   
7. tcpdump  
	截获分析网络数据包  
8. lsof  
	列出当前系统打开的文件列表   
9. otool  
	查看程序依赖的动态库信息   
10. nm  
	显示符号表  
11. ldid  
	签名工具   
12. gdb  
13. ssh





## 连接 Iphone 

### 1. WiFi连接  
    
    `ssh root/mobile@IP`  
    密码： `alpine`

### 2. USB 连接  
`usbmuxd`: `System/Library/PrivateFrameworks/MobileDevice.framework/Resource/usbmuxd`  
将Mac 端口数据，转发到 iPhone 端口   

1. 下载 usbmuxd 工具包 (1.0.8版本)  
    `cd ~/usbmuxd/python-client`  
    `python tcprelay.py -t 22:10010` 
    * 连接 
    `ssh -p 10010 root@localhost`

    * 远程拷贝  
    `scp -P 10010 ~/.ssh/id_rsa.pub root@localhost:~`  

2. 替代工具(itnl)  
    `./itnl --iport 22 --lport 10010`  







## 中文支持 
新建 `~/.inputrc`文件

```
set convert-meta off  
# 允许向终端输出中文   
set output-meta on 

# 允许向终端输入中文
set meta-flag on 
set input-meta on 



```

## swift 逆向  
1. 动态部分  
	* OC 相同方式  
2. 静态部分  
	* 使用 Cydia Substrate 的MobileHooker -- MSHookFunction 进行操作  
3. 非越狱环境  
	使用第三方 inline hook 库(substitute) 实现hook 
	* 查找对应函数的内存地址  
		`image lookup -rn XXXXDemo.*CustomMethod` 




## frida  
1. frida-trace  
	`frida-trace -U -m "-[HomeController aboutButtonAction]"  Cydia`  
	* 在当前目录下生成，`handlers`目录，并生成 `.js` 文件  
	* 可以通过在此文件中对应位置添加`断点`  
		`Thread.backtrace(this.context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join('\n\t')`
	* 通配符支持  
		`frida-trace -U -m "-[Home* *]" Cydia` Home开头的类，方法名任意   

	* 拦截C 函数，添加拦截器  

		```
		Interceptor.attach(Module.findExportByName(null, "fopen"), {
		
		});
		```
		
		* 加载  
			`frida -U -l /Users/xxxx/.js   XXXX`
		* 方式2： 
			`frida -U XXXX`  
			`%load /Users/xxxx/.js`   
	* 拦截OC 方法  
		
		```
		var className = "NSURL"  
		var funcName = "+ URLWithString:"  
		
		var hook = eval('ObjC.classes.' + className + '["' + funcName + ']"') 
		Interceptor.attach(hook.implementation, {
		
		})
		```
	* 针对在程序启动时就执行的函数进行操作  
		`frida -U -l xxxx.js -f com.xxxx.xxx` 然后输入 `%resume` 程序执行。 可以使用`--no-pause`
## 理论  
1. iOS 系统的安装包   
    * deb 格式的集合软件包管理工具 apt  
    * 离线安装:  
        * 下载对应的 deb 文件 
        * 将 deb 放到手机的 `/var/root/Media/Cydia/AutoInstall` 目录   
        * 重启手机   

2. SSL/OpenSSL/SSH/OpenSSH 
    * SSL 
        为网络通信提供安全及数据完整性的安全协议， 在传输层对网络进行加密  
    * OpenSSL
        SSL 的开源实现  
    * SSH   
         更多的则被设计为加强Telnet/FTP安全的传输协议,默认地,它使用22端口.
    * OpenSSH
        通过OpenSSL完成  

	查看SSH 版本   
	
	* 客户端：`/etc/ssh/ssh_config`  
	* 服务端: `/etc/ssh/sshd_config`

3. SSH 连接  
    1. SSH建立安全连接  
        * 通过用户名和IP进行连接
        * 服务器发送公钥到客户端  
        * 客户端将公钥存储到 `~/.ssh/know_hosts` 文件中  
    2. 客户端认证  
        * 基于密码  
        * 基于秘钥   
            将客户端公钥，放入到服务器的授权文件中`~/.ssh/authorized_keys`
    3. 登录认证  

