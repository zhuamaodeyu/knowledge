# theos  

## 配置
### 项目配置  
    ```
    // Makefile 
    export THEOS_DEVICE_IP=127.0.0.1 
    export THEOS_DEVICE_PORT=10010     


    ```
### 代码实现 
> 在 Twak.xm 文件中进行具体的实现  

```
%hook   要hook的类名

// 此处写要hook的方法  

%end
```

### 安装已经打包的插件 
```
make
make package  
// make package debug=0

make install 
```



## 练习  
### 练习1 (SprintBoot）
去除桌面应用的小红点     
1. 找到对应的应用程序  
2. 去壳  
3. class-dump 获取所有的头文件  
4. 分析小红点所在的位置及对应的类  
5. tweak  
    ```
    %hook 类名
    -(id) init {
        return nil; 

    }
    %end
    ```

### 练习2 (微信)  
微信添加cell  

```
%hook  FindFriendEntryViewController

-(Integer) numberOfSectionsInTableView:(id)arg1{
    // 调用原始的方法 %orig ,默认会传入原来的参数  
    return %orig + 1;
}

-(long long)tableView:(id)arg1 numberOfRowsInSection(long long)section{
    
    <!-- section == 最后一组 -->
    if(section == [self numberOfSectionsInTableView:arg1] - 1){
        return 2;
    }else {
        return %orig;
    }

}

-(id)tableView:(id)arg1 cellForRowAtIndexPath:(id)indexPath {


    if ([indexPath section] != [self numberOfSectionsInTableView:arg1] - 1) {
        return %orig;
    }
    
}

-(void)tableView:(id)tableView didSelectRowAtIndexPath:(id)indexPath {
    if ([indexPath section] != [self numberOfSectionsInTableView:arg1] - 1) {
        return %orig;
    }
    [tableView deselectRowAtIndexPath:indexPath animated:YES]; 

    // 退出微信 
    if([indexPath row] == 1) {
        // 此方式有卡顿效果 
        exit(0);
        // 终止进程  
        abort();
    }
}


// 添加新的方法 
%new 
-(void)action:(UIButton *)button {

}

%end
```


### 练习3 (段子)  
去除广告。 
* 方法1： 将cell的高度变为 0  
* 方法2： 针对模型，在数据转模型时，返回nil  




#### 注意 
1. 添加新方法  
    hook中实现的方法默认都是替换的方法，如果需要自己添加方法，需要在方法前添加 `%new` 来实现
2. 添加新图片资源  
    ```
    UIImage *image = [UIImage imageWithContentOfFile:@"/xxx/xxx/xxx/"];
    ```
    * 在weak 项目中添加 `layout` 文件夹，将资源文件放入到当前路径下  
        > layout 相当于当前设备的`Device`目录，如果需要将资源文件放入到其他目录中，需要在此处根据路径建立对应的目录   
3. 多文件开发  
    可以添加 OC 文件 
    需要修改`Makefile`文件`xxxxx_FILES` 多个文件路径通过 空格 分开   
    > 必须指定文件夹，可以不指定文件名`src/*.xm src/Model/*.m`     
    > 通配符写法： `${wildcard src/*.xm}`  

4. 获取系统中的类定义 
    `%c(类名)` 等价于 `NSClassFromString(@"xxxx")`  



### 练习4 (去除腾讯视频启动广告和视频广告)  
#### 开机启动广告  
```
@interface XXXXXX
-(void)hideSplash;
@end

%hook TADSplashWindow 

-(void)showSplash {
    [self hideSplash];
}
%end
```
##### 视频广告 
```
// 广告 
QNBPlayerVideoAdsView ------ QNBPlayerVideoAdsViewController

// 视频内容 
TVKVideoView ------- QNBAVPlayerViewController 


%hook  QNBPlayerVideoAdsViewController 

-(id)initWithEvenProxy:(id)...... {
    return nil;
}

%end
```

###### xm 类中引入类和协议  
```
// 引入类
@class XXXXView, XXXController;


// 引入协议
@protocol  XXXXDelegate, XXXXXDataSource;


// 遇到 __weak 问题，直接替换为 空  

```





## Logos语法 
1. `%hook`:开始
2. `%end` :结束
3. `%new` :添加一个新的方法 
4. `%c`   :生成一个Class对象，类似于 NSStringFromClass(),objc_getClass()  
5. `%orig`:函数原来的代码逻辑   
6. `%ctor`:在加载动态库时调用  
7. `%dtor`: 在程序退出时调用   
8. `logify.pl`: 可以将一个头文件快速转换成已经包含打印信息的xm 文件  
    `logify.pl xxx.h > xxx.xm`  

9. `%log`: 可以通过 `Xcode --->Window--->Devices and Simulator`查看日志  
10. `HBDebugLog`: 跟 NSLog 类似  







## Q&A  
1. make： 编译 tweak 代码为动态库 (*.dylib)  
2. make package: 将动态库打包为 deb 文件  
3. make install : 将 deb 文件传送到手机， 通过Cydia 安装 deb  
    * 插件会安装在 `/Library/MobileSubstrate/DynamicLibraries`  
        * `*.dylib`: 编译后的 tweak 代码  
        * `*.plist`:存放需要hook 的APPID
4. 当打开App时： 
    * Cydia Substrate 会让App 去加载对应的dylib  
    * 修改App 内存中的代码逻辑， 去执行dylib 中的函数代码  
5. theos 的 tweak 代码并不会对APP原有的可执行文件进行修改，仅修改内存中的代码逻辑   

6. 未脱壳的APP是否支持 tweak？  
    可以,更改的时内存中的，在开发过程中，脱壳只是为了分析和实现    
7. tweak修过是否永久性的？ 
    取决于APP的代码是否更改     
8. 如果一旦更新APP， tweak是否会失效？  
    取决于tweak中用到的APP代码是否更改      
9. 未越狱的手机是否支持tweak？ 
    不可以。没越狱是没有Cydia     
10. 能不能对swift/C 函数进行tweak？ 
    可以  

